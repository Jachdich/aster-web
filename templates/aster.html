<html>
<head>

<link rel="stylesheet" href="{{ url_for("static", filename="stylesheet.css") }}"></link>

</head>
<body>
<script src="{{ url_for("static", filename="socket.io.js") }}" type="text/javascript"></script>

<div id="idkwhatthisis">
    <div id="servers">
        <button class="server">
            <img class="serverimg" src="{{ url_for("static", filename="jellyfish.png") }}">
        </button>
        <button class="server">
            <img class="serverimg" src="{{ url_for("static", filename="jellyfish.png") }}">
        </button>
    </div>
    <br>
    <div id="servercontent">
        <div id="channels">
            <ul id="channel_list"></ul>
        </div>
        <div id="messagearea-outer">
            <div id="messagearea"></div>
        </div>
        <div id="emojis"><p>test</p><p>test2</p></div>
    </div>
</div>

<div id="login">
    <label id="sync_ip_label" for="sync_ip">Sync&nbsp;server&nbsp;IP&nbsp;<span id="sync_info"><a href="{{ url_for("static", filename="sync_help.html") }}">info</a></span></label>
    <input id="sync_ip_input" type="text" placeholder="Enter IP" name="sync_ip" class="login_input" required>
    <label id="sync_port_label" for="sync_port">Sync&nbsp;server&nbsp;port</label>
    <input id="sync_port_input" type="text" placeholder="Enter port" name="sync_port" class="login_input" required>
    <label id="uname_label" for="uname">Username</label>
    <input id="uname_input" type="text" placeholder="Enter Username" name="uname" class="login_input" required>
    <label id="pw_label" for="psw">Password</label>
    <input id="pw_input" type="password" placeholder="Enter Password" name="psw" class="login_input" required>
    <button id="login_button">Login</button>
</div>

<input rows="1" autofocus="true" id="msgbox"></input>
<script>

let socket = io();
let total_emojis = [];
let show_emojis = false;

document.getElementById("msgbox").onkeypress = function(key) {
    let elem = document.getElementById("msgbox");
    if (key.keyCode === 13) {
        socket.send({req: "send_message", message: elem.value});
        elem.value = "";
    }
    if (elem.value.endsWith(":") && !show_emojis) {
        show_emojis = true;
        document.getElementById("emojis").style.display = "";
    } else if (!elem.value.endsWith(":") && show_emojis) {
        show_emojis = false;
        document.getElementById("emojis").style.display = "none";
    }
}

document.getElementById("login_button").onclick = function() {
    socket.send({req: "login",
        sync_ip:   document.getElementById("sync_ip_input").value,
        sync_port: parseInt(document.getElementById("sync_port_input").value),
        uname:     document.getElementById("uname_input").value,
        password:  document.getElementById("pw_input").value});
    document.getElementById("idkwhatthisis").style.display = "flex";
    document.getElementById("login").style.display = "none";
}

document.getElementById("idkwhatthisis").style.display = "none";

socket.on("message", function(data) {
    let total_html = "";
    for (const val of data["messages"]) {
        const small = false;
        let smalltxt = "";
        if (small) {
            smalltxt = "small-";
        }
        let image_html = "";
        if (!small) {
            image_html = `
            <span class="pfp">
                <img src="/aster/pfp/${val["author_uuid"]}.png" class="pfp_image"></img>
            </span>
            `;
        }
        const html = `
        <div class="${smalltxt}message">
            ${image_html}
            <span class="${smalltxt}uname">${val["author"]}: </span>
            <p class="${smalltxt}msgbody">${val["content"]}</p>
            <p class="${smalltxt}msgdate">12/05/22 14:32</p>
        </div>
        `;

        total_html += html;
    }
    let elem = document.getElementById("messagearea");
    elem.innerHTML += total_html;
    elem.scrollTop = elem.scrollHeight;
});

socket.on("channels", function(data) {
    let elem = document.getElementById("channel_list");
    for (const channel of data) {
        const name = channel["name"];
        //basically what this atrosity does is
        //add # onto the start of the channel name if it doesn't already start with # or &
        const prefix = name.charAt(0) == '&' ? '' : (name.charAt(0) == '#' ? '' : '#');
        const html = `
            <button class="channel_item" onclick="changeChannel('${name}')">${prefix}${name}</button>
        `;
        elem.innerHTML += html;
    }
});

socket.on("emojis", function(data) {
    for (const emoji of data) {
        total_emojis.push(emoji);
    }
});

function changeChannel(channel) {
    let elem = document.getElementById("messagearea");
    elem.innerHTML = "";
    socket.send({req: "change_channel", channel: channel}); 
}

</script>
</body>
</html>
