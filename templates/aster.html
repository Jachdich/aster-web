<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet" href="{{ url_for("static", filename="stylesheet.css") }}">
<title>Aster</title>
</head>
<body>
<script src="{{ url_for("static", filename="socket.io.js") }}" type="text/javascript"></script>

<div id="idkwhatthisis">
<div class="top">
    <div class="server-list">
        <div class="server-module"><img src="republic.jpg" class="server-icon"></div>
        <div class="server-module">
            <img src="cospox.png" class="server-icon">
            <div class="module-user-indicator"></div>
            <img src="server_select.png" class="server-selection-indicator">
        </div>
        <div class="server-module-disabled"><img src="hhv3.png" class="server-icon-disabled"></div>
    </div>
    <button id="add-server"><img src="add_2.png" class="icon"></button>
    <button id="settings"><img src="butterfly.png" class="pfp"></button>
</div>

<div class="server-header">
    <h1 class="server-name">Cospox</h1>
    <div class="user-indicator"></div>
    <h1 id="server-user-label" class="server-status-label">n/a online</h1>
    <img src="ping.png" class="ping-indicator">
    <h1 id="server-ping-label" class="server-status-label">17ms</h1>
    <div class="server-header-seperator"></div>
    <button id="server-notifs"><img src="bell.png" class="icon-small"></button>
</div>

<div id="server-area">
    <div id="server-channels">
        <ul id="channel-list">
        </ul>
    </div>
    <div id="server-chat">
        <input rows="1" autofocus="true" id="server-chat-msgbox" placeholder=" Send a message">
        <div id="message-area">
            <div class="message">
            </div>
        </div>
    </div>
</div>
</div>
<!--
<div id="idkwhatthisis">
    <div id="topcontent">
        <div id="servers"></div>
        <div id="buttons">
            <button id="add_server"><img src="{{ url_for("static", filename="add.png") }}"></button>
            <button id="settings"><img src="{{ url_for("static", filename="settings.png") }}"></button>
        </div>
    </div>
    <br>
    <div id="servercontent">
        <div id="channels">
            <ul id="channel_list"></ul>
        </div>
        <div id="messagearea-outer">
            <div id="message-area"></div>
        </div>
        <div id="emojis"><p>test</p><p>test2</p></div>
    </div>
    <input rows="1" autofocus="true" id="msgbox">
</div>-->

<div id="login">
    <label id="sync_ip_label" for="sync_ip_input">Sync&nbsp;server&nbsp;IP&nbsp;<span id="sync_info"><a href="{{ url_for("static", filename="sync_help.html") }}">info</a></span></label>
    <input id="sync_ip_input" type="text" placeholder="Enter IP" class="login_input" required>
    <label id="sync_port_label" for="sync_port_input">Sync&nbsp;server&nbsp;port</label>
    <input id="sync_port_input" type="text" placeholder="Enter port" class="login_input" required>
    <label id="uname_label" for="uname_input">Username</label>
    <input id="uname_input" type="text" placeholder="Enter Username" class="login_input" required>
    <label id="pw_label" for="pw_input">Password</label>
    <input id="pw_input" type="password" placeholder="Enter Password" class="login_input" required>
    <button id="login_button">Login</button>
</div>

<div id="prefs" class="popup">
    <span id="s_t_uname">Username</span>
    <input id="s_uname">

    <span id="s_t_pfp">Profile Picture</span>
    <button id="s_pfp">test</button>

    <span id="s_t_passwd">Password</span>
    <input type="password" id="s_passwd">

    <button id="s_cancel">Cancel</button>
    <button id="s_ok">Ok</button>
</div>

<div id="new_server" class="popup">
    <span id="n_t_ip">IP</span>
    <input id="n_ip">

    <span id="n_t_port">Port</span>
    <input id="n_port">
    <div id="n_buttons">
        <button id="n_cancel">Cancel</button>
        <button id="n_ok">Ok</button>
    </div>
</div>

<div id="error_box" class="popup">
    <span id="error_msg"></span>
    <button id="e_ok">Ok</button>
</div>

<div id="background_fade"></div>

<script>
"use strict";
let socket = io();
let total_emojis = [];
let show_emojis = false;
let channel_buttons = [];
let queued_errors = [];
let self_user = undefined;

function show_settings() {
    document.getElementById("prefs").style.display = "grid";
    document.getElementById("background_fade").style.display = "block";
}

function hide_settings() {
    document.getElementById("prefs").style.display = "none";
    document.getElementById("background_fade").style.display = "none";
}

function set_default_settings() {
    //TODO
}

function show_new_server() {
    document.getElementById("new_server").style.display = "grid";
    document.getElementById("background_fade").style.display = "block";
}

function hide_new_server() {
    document.getElementById("new_server").style.display = "none";
    document.getElementById("background_fade").style.display = "none";
}

function clear_new_server() {
    document.getElementById("n_port").value = "2345";
    document.getElementById("n_ip").value = ""; 
}

function show_error() {
    const text = queued_errors.pop();
    document.getElementById("error_msg").innerText = text;
    document.getElementById("error_box").style.display = "grid";
    document.getElementById("background_fade").style.display = "block";
}

function add_error(text) {
    queued_errors.push(text);
    const display = document.getElementById("error_box").style.display;
    if (display === "none" || display === "") {
        show_error();
    }
}

hide_settings();
hide_new_server();
set_default_settings();
clear_new_server();

document.getElementById("settings").onclick = show_settings;
document.getElementById("add-server").onclick = show_new_server;
document.getElementById("s_cancel").onclick = function() {
    hide_settings();
    set_default_settings();
}

document.getElementById("n_cancel").onclick = function() {
    hide_new_server();
    clear_new_server();
}

document.getElementById("n_ok").onclick = function() {
    const ip = document.getElementById("n_ip");
    const port = document.getElementById("n_port");
    const msg = {
        req: "add_server",
        ip: ip,
        port: port
    };
    socket.send(msg);
    hide_new_server();
    clear_new_server();
}

document.getElementById("e_ok").onclick = function() {
    if (queued_errors.length > 0) {
        show_error();
    } else {
        document.getElementById("error_box").style.display = "none";
        document.getElementById("background_fade").style.display = "none";
    }
}

socket.on("add_server_status", function(data) {
    add_server(data);
});

socket.on("self", function(data) {
    self_user = data;
});

document.getElementById("server-chat-msgbox").onkeypress = function(key) {
    let elem = document.getElementById("server-chat-msgbox");
    if (key.keyCode === 13) {
        socket.send({req: "send_message", message: elem.value});
        //TODO set partial message
        elem.value = "";
        return;
    }
}

document.getElementById("server-chat-msgbox").oninput = function(event) {
    const elem = document.getElementById("server-chat-msgbox");
    const last_word = elem.value.split(" ").at(-1);
    if (last_word.startsWith(":") && !show_emojis) {
        show_emojis = true;
        document.getElementById("emojis").style.display = "block";
    } else if (!last_word.startsWith(":") && show_emojis) {
        show_emojis = false;
        document.getElementById("emojis").style.display = "none";
    }
}

document.getElementById("login_button").onclick = function() {
    const msg = {
        req: "login",
        sync_ip:   document.getElementById("sync_ip_input").value,
        sync_port: parseInt(document.getElementById("sync_port_input").value),
        uname:     document.getElementById("uname_input").value,
        password:  document.getElementById("pw_input").value
    };
    socket.send(msg);
    document.getElementById("idkwhatthisis").style.display = "grid";
    document.getElementById("login").style.display = "none";
    document.cookie = `sync_ip=${msg.sync_ip}; sync_port=${msg.sync_port}; expires=2038-01-19, 03:14:08 UTC`;
}

{
    let elem = document.getElementById("sync_port_input");
    if (elem.value === "") {
        elem.value = "2345";
    }
}

document.getElementById("idkwhatthisis").style.display = "none";

function get_html_from_message(val) {
    const small = false;
    let smalltxt = "";
    if (small) {
        smalltxt = "small-";
    }
    let image_html = "";
    if (!small) {
        image_html = `
        <img src="/aster/pfp/${val["author_uuid"]}.png" class="msgpfp">
        `;
    }

    let date = new Date(val["date"] * 1000);
    let date_str = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
    const html = `
    <div class="${smalltxt}message">
        ${image_html}
        <p class="${smalltxt}msguser">${val["author"]}: </p>
        <p class="${smalltxt}msgbody">${val["content"]}</p>
        <p class="${smalltxt}msgdate">${date_str}</p>
    </div>
    `;
    return html;
}

socket.on("message", function(data) {
    let total_html = "";
    for (const val of data["messages"]) {
        let html = get_html_from_message(val);
        total_html += html;
    }
    let elem = document.getElementById("message-area");
    elem.innerHTML += total_html;
    elem.scrollTop = elem.scrollHeight;
});

socket.on("login_successful", function(id) {
    set_default_settings();
});

socket.on("channels", function(data) {
    let elem = document.getElementById("channel-list");
    for (let channel of channel_buttons) {
        channel.remove();
    }
    for (const channel of data) {
        const name = channel["name"];
        //basically what this atrosity does is
        //add # onto the start of the channel name if it doesn't already start with # or &
        const prefix = name.charAt(0) == '&' ? '' : (name.charAt(0) == '#' ? '' : '#');
        let button = document.createElement("button");
        button.className = "channel-button";
        button.onclick = function() { changeChannel(name, button); };
        button.innerText = prefix + name;
        button.setAttribute("value", 0);
        
        channel_buttons.push(button);
        elem.appendChild(button);
    }
    channel_buttons[0].value = "1";
});

socket.on("emojis", function(data) { for (const emoji of data) { total_emojis.push(emoji); } });
socket.on("servers", function(data) { for (const server of data) { add_server(server); } });

socket.on("sync_server_dead", function() {
    alert("The sync server you entered is offline");
    document.getElementById("idkwhatthisis").style.display = "none";
    document.getElementById("login").style.display = "grid";
});

function changeChannel(channel, button) {
    if (button.value == "1") return;
    for (let b of channel_buttons) {
        b.value = 0;
    }
    button.value = 1;
    let elem = document.getElementById("message-area");
    elem.innerHTML = "";
    socket.send({req: "change_channel", channel: channel});
}

let server_buttons = [];

function server_button_clicked(button) {
    if (button.value == "1") return; //no need to do anything, button already selected

    //disable all other buttons
    for (let b of server_buttons) {
        b.value = "0";
    }
    button.value = "1";
}

function add_server(server) {
    let button = document.createElement("button");
    button.className = "server";
    button.setAttribute("value", 0);
    const img = document.createElement("img")
    img.className = "serverimg";
    img.src = server["img"];
    button.appendChild(img)
    document.getElementById("servers").appendChild(button);

    button.onclick = function() {
        server_button_clicked(button);
    }

    server_buttons.push(button);
}
</script>
</body>
</html>
